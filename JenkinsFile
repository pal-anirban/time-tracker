pipeline {
    agent any
    environment { 
        DeployFlag = 'N'
        TomcatPath = 'C:/External Software/apache-tomcat-9.0.46-windows-x64/apache-tomcat-9.0.46'
        Tomcat_Login = credentials('jenkinsJenkinsMS')
        Tomcat_URL = 'http://localhost:8081/'
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'master', url: 'https://github.com/pal-anirban/time-tracker.git'
            }
        }
 		stage("Parallel Execution for Build") {
			steps {
				parallel(
				      cleaning: {
					bat "mvn clean"
				      },
				      testing: {
					bat "mvn test"
				      },
				      packageing: {
					bat "mvn package"
				      }
				)
			}
			post {
			    always { 
           			 echo 'Build step executed. Status - ${currentBuild.currentResult}'
       			 }
                success {
                	echo 'Build Successful'
                    archiveArtifacts 'target/*.war'
                    script {
						DeployFlag = 'Y'
                	}         
                }
                failure {
            		mail bcc: '', body: '', cc: '', from: '', replyTo: '', subject: 'Build Failure', to: 'anirbantatai@gmail.com'
        }   
            }       
		}
		stage('Tomcat Deployment') {
            steps {
            	when{
            	    expression { env.DeployFlag == 'Y' }        	    
            	}
            	steps {
               		deploy adapters: [tomcat9($Tomcat_Login, path: '', url: $Tomcat_URL)], contextPath: 'TimeTracker', onFailure: false, war: '**/*.war'
           		 }	
            }

            post {
                  always { 
           			 echo 'Deployment step executed'
       			 }
                success {
                	echo 'Deployment Successful'
                }
                
            }
        }
    }
}
